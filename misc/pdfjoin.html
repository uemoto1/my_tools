<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF連結（表紙＋本文）</title>

  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- pdf-lib (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    .dropzone {
      border: 2px dashed #adb5bd;
      border-radius: 12px;
      padding: 18px;
      background: #f8f9fa;
      transition: .15s ease-in-out;
      cursor: pointer;
      user-select: none;
    }
    .dropzone.dragover {
      background: #eef6ff;
      border-color: #0d6efd;
    }
    .file-meta {
      font-size: 0.95rem;
      color: #495057;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-9 col-xl-8">

        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h1 class="h4 mb-2">PDFファイル連結（表紙 + 本文）</h1>
            <p class="text-secondary mb-4">
              表紙PDFと本文PDFを選んで「PDF連結実行」を押すと、連結後のPDFが自動でダウンロードされます。
            </p>

            <div id="alertArea"></div>

            <!-- Cover -->
            <div class="mb-3">
              <label class="form-label fw-semibold">表紙PDFファイル</label>
              <div id="dzCover" class="dropzone">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="badge text-bg-primary">ドラッグ&ドロップ</span>
                  <span class="text-secondary">または</span>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="btnCoverPick">
                    ファイル選択
                  </button>
                </div>
                <div class="mt-2 file-meta" id="metaCover">未選択</div>
                <input type="file" id="inCover" accept="application/pdf" class="d-none">
              </div>
            </div>

            <!-- Body -->
            <div class="mb-3">
              <label class="form-label fw-semibold">本文PDFファイル</label>
              <div id="dzBody" class="dropzone">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="badge text-bg-primary">ドラッグ&ドロップ</span>
                  <span class="text-secondary">または</span>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="btnBodyPick">
                    ファイル選択
                  </button>
                </div>
                <div class="mt-2 file-meta" id="metaBody">未選択</div>
                <input type="file" id="inBody" accept="application/pdf" class="d-none">
              </div>
            </div>

            <!-- Options -->
            <div class="form-check mb-4">
              <input class="form-check-input" type="checkbox" id="chkSkipFirst" />
              <label class="form-check-label" for="chkSkipFirst">
                本文の1ページ目を除外
              </label>
              <div class="form-text">
                チェックすると、本文PDFの先頭1ページをスキップして連結します（デフォルト：オフ）
              </div>
            </div>

            <!-- Run -->
            <div class="d-grid">
              <button class="btn btn-success btn-lg" id="btnMerge" disabled>
                PDF連結実行
              </button>
            </div>

            <div class="mt-3 text-secondary small">
              仕様メモ：
              <span class="mono">pdf-lib</span> によりブラウザ内でPDFを読み込み、ページをコピーして新規PDFを生成します。
              暗号化PDFなど一部のPDFは読み込めない場合があります。
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS (optional; not strictly required here, but included) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== State =====
    let coverFile = null;
    let bodyFile = null;
    let coverPageCount = null;
    let bodyPageCount = null;

    // ===== DOM =====
    const alertArea = document.getElementById('alertArea');

    const dzCover = document.getElementById('dzCover');
    const dzBody  = document.getElementById('dzBody');

    const inCover = document.getElementById('inCover');
    const inBody  = document.getElementById('inBody');

    const btnCoverPick = document.getElementById('btnCoverPick');
    const btnBodyPick  = document.getElementById('btnBodyPick');

    const metaCover = document.getElementById('metaCover');
    const metaBody  = document.getElementById('metaBody');

    const chkSkipFirst = document.getElementById('chkSkipFirst');
    const btnMerge = document.getElementById('btnMerge');

    // ===== Helpers =====
    function showAlert(message, type = 'danger') {
      alertArea.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${escapeHtml(message)}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
    }

    function clearAlert() {
      alertArea.innerHTML = '';
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function formatBytes(bytes) {
      if (!Number.isFinite(bytes)) return '';
      const units = ['B','KB','MB','GB'];
      let b = bytes;
      let i = 0;
      while (b >= 1024 && i < units.length - 1) { b /= 1024; i++; }
      return `${b.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    }

    function nowFilename() {
      const d = new Date();
      const pad = n => String(n).padStart(2, '0');
      return `merged_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}.pdf`;
    }

    function setMergeButtonState() {
      btnMerge.disabled = !(coverFile && bodyFile);
    }

    async function readPdfInfo(file) {
      const arrayBuffer = await file.arrayBuffer();
      // pdf-lib は暗号化PDFなどでエラーになることがあります
      const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer, { ignoreEncryption: false });
      return { arrayBuffer, pageCount: pdfDoc.getPageCount() };
    }

    function setMeta(el, file, pageCount) {
      if (!file) {
        el.textContent = '未選択';
        return;
      }
      const pagesText = (pageCount != null) ? ` / ${pageCount}ページ` : '';
      el.innerHTML = `
        <div><span class="fw-semibold">${escapeHtml(file.name)}</span></div>
        <div class="text-secondary">${formatBytes(file.size)}${pagesText}</div>
      `;
    }

    function wireDropzone(dropEl, inputEl, onFileChosen) {
      // click -> open file picker
      dropEl.addEventListener('click', (e) => {
        // ボタン押下時はボタン側のハンドラで処理するので、ドロップゾーンのクリックでは開かない
        if (e.target && (e.target.id === 'btnCoverPick' || e.target.id === 'btnBodyPick')) return;
        inputEl.click();
      });

      // input change
      inputEl.addEventListener('change', async () => {
        const f = inputEl.files && inputEl.files[0] ? inputEl.files[0] : null;
        await onFileChosen(f);
        // 同じファイルを再選択できるようにする
        inputEl.value = '';
      });

      // dragover / drop
      dropEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropEl.classList.add('dragover');
      });
      dropEl.addEventListener('dragleave', () => {
        dropEl.classList.remove('dragover');
      });
      dropEl.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropEl.classList.remove('dragover');
        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0] ? e.dataTransfer.files[0] : null;
        await onFileChosen(f);
      });
    }

    // ===== File selection handlers =====
    async function chooseCover(f) {
      clearAlert();
      if (!f) return;

      if (f.type !== 'application/pdf' && !f.name.toLowerCase().endsWith('.pdf')) {
        showAlert('表紙ファイルはPDFを指定してください。', 'warning');
        return;
      }

      try {
        const info = await readPdfInfo(f);
        coverFile = f;
        coverPageCount = info.pageCount;
        setMeta(metaCover, coverFile, coverPageCount);
        setMergeButtonState();
      } catch (err) {
        coverFile = null; coverPageCount = null;
        setMeta(metaCover, null, null);
        setMergeButtonState();
        showAlert(`表紙PDFの読み込みに失敗しました（暗号化PDF等の可能性）: ${err?.message ?? err}`, 'danger');
      }
    }

    async function chooseBody(f) {
      clearAlert();
      if (!f) return;

      if (f.type !== 'application/pdf' && !f.name.toLowerCase().endsWith('.pdf')) {
        showAlert('本文ファイルはPDFを指定してください。', 'warning');
        return;
      }

      try {
        const info = await readPdfInfo(f);
        bodyFile = f;
        bodyPageCount = info.pageCount;
        setMeta(metaBody, bodyFile, bodyPageCount);
        setMergeButtonState();
      } catch (err) {
        bodyFile = null; bodyPageCount = null;
        setMeta(metaBody, null, null);
        setMergeButtonState();
        showAlert(`本文PDFの読み込みに失敗しました（暗号化PDF等の可能性）: ${err?.message ?? err}`, 'danger');
      }
    }

    // ===== Merge =====
    async function mergeAndDownload() {
      clearAlert();

      if (!coverFile || !bodyFile) {
        showAlert('表紙PDFと本文PDFの2つを指定してください。', 'warning');
        return;
      }

      btnMerge.disabled = true;
      btnMerge.textContent = '連結中...';

      try {
        const skipFirst = chkSkipFirst.checked;

        // load source PDFs
        const coverBytes = await coverFile.arrayBuffer();
        const bodyBytes  = await bodyFile.arrayBuffer();

        const coverDoc = await PDFLib.PDFDocument.load(coverBytes, { ignoreEncryption: false });
        const bodyDoc  = await PDFLib.PDFDocument.load(bodyBytes,  { ignoreEncryption: false });

        const outDoc = await PDFLib.PDFDocument.create();

        // copy cover pages
        {
          const coverIndices = [...Array(coverDoc.getPageCount()).keys()];
          const coverPages = await outDoc.copyPages(coverDoc, coverIndices);
          coverPages.forEach(p => outDoc.addPage(p));
        }

        // copy body pages (optionally skip first)
        {
          const total = bodyDoc.getPageCount();
          if (skipFirst && total <= 1) {
            // 本文が1ページしかない場合、スキップすると何も残らない
            showAlert('本文PDFが1ページ以下のため「本文の1ページ目を除外」を適用すると本文が空になります。', 'warning');
          }

          const start = (skipFirst ? 1 : 0);
          const bodyIndices = [];
          for (let i = start; i < total; i++) bodyIndices.push(i);

          const bodyPages = await outDoc.copyPages(bodyDoc, bodyIndices);
          bodyPages.forEach(p => outDoc.addPage(p));
        }

        const outBytes = await outDoc.save();

        // download
        const blob = new Blob([outBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = nowFilename();
        document.body.appendChild(a);
        a.click();
        a.remove();

        setTimeout(() => URL.revokeObjectURL(url), 2000);

        showAlert('連結したPDFのダウンロードを開始しました。', 'success');
      } catch (err) {
        showAlert(`PDF連結に失敗しました: ${err?.message ?? err}`, 'danger');
      } finally {
        btnMerge.textContent = 'PDF連結実行';
        setMergeButtonState();
      }
    }

    // ===== Wire UI =====
    btnCoverPick.addEventListener('click', () => inCover.click());
    btnBodyPick.addEventListener('click', () => inBody.click());

    wireDropzone(dzCover, inCover, chooseCover);
    wireDropzone(dzBody,  inBody,  chooseBody);

    btnMerge.addEventListener('click', mergeAndDownload);

    // initial
    setMergeButtonState();
  </script>
</body>
</html>


